<include file="./Application/Home/View/headers.html"/>
<link rel="stylesheet" href="__TPL__lib/select2/css/select2.min.css"/>
<style>
    .disabled {
        cursor: no-drop;
        background-color: rgb(235, 235, 228);
    }
    .input-text {
        width: 78%
    }
    .hidden{
        display: none;
    }
</style>
<script type="text/javascript" src="__TPL__lib/select2/js/select2.min.js"></script>
<script type="text/javascript" src="__TPL__lib/select2/js/i18n/zh-CN.js"></script>
<script type="text/javascript" src="__TPL__static/select.js"></script>
<article class="page-container" style=" overflow:hidden;" id="input_list">
    <form action="" method="post" class="form form-horizontal" id="form-member-add">
        <div>
            <div class="row cl col-sm-12" style="margin-top: 0">
                <p>基本信息</p>
                <hr/>
                <br/>
                <label class="form-label col-xs-2 "><span class="c-red">*</span>调拨数量(吨):</label>

                <div class="formControls col-xs-9 col-sm-4">
                    <input class="input-text disabled" disabled value="<{$data.order.num}>" name="num">
                    <input type="hidden" class="input-text disabled" disabled value="<{$data.order.num}>" id="wait_outbound_num">
                    <span id="sps1"></span>
                </div>

                <label class="form-label col-xs-2 "><span class="c-red">*</span>出库类型:</label>

                <div class="formControls col-xs-9 col-sm-4">
                    <input class="input-text disabled" disabled value="<{$data.order.out_type}>" name="out_type">
                    <span id="sps2"></span>
                </div>
            </div>
        </div>
        <!--<div>-->
            <!--<div class="row cl col-sm-12">-->
                <!--<label class="form-label col-xs-2 "><span class="c-red">*</span>调拨类型:</label>-->
                <!--<input type="radio" name="allocation_type" value="1" style="margin-left: 15px" checked="checked">城市仓->二级仓-->
                <!--<input type="radio" name="allocation_type" value="2" style="margin-left: 15px">二级仓->二级仓-->
                <!--<input type="radio" name="allocation_type" value="3" style="margin-left: 15px">二级仓->城市仓-->
                <!--<input type="radio" name="allocation_type" value="4" style="margin-left: 15px">城市仓->城市仓-->
            <!--</div>-->
        <!--</div>-->
        <!--<div>
            <div class="row cl col-sm-12">
                <label class="form-label col-xs-2 "><span class="c-red">*</span>出库类型:</label>

                <div class="formControls col-xs-9 col-sm-4">
                    <input class="input-text disabled" disabled value="<{$data.order.out_type}>" name="out_type">
                    <span id="sps2"></span>
                </div>

                <div>
                    <label class="form-label col-xs-2 "><span class="c-red">*</span>入库类型:</label>

                    <div class="formControls col-xs-9 col-sm-4">
                        <input class="input-text disabled" disabled value="<{$data.order.in_type}>" name="in_type">
                        <span id="sps3"></span>
                    </div>
                </div>


            </div>
            -->
            <div  class="row cl col-sm-12">
                <div id="out_t" style="display: none;">
                    <label class="form-label col-xs-2" style="padding:0;"><span class="c-red">*</span>实际出库数量(吨):</label>

                    <div class="formControls col-xs-9 col-sm-4">
                        <input class="input-text " value="" name="outbound_num" id="outbound_num" onkeyup="checknum(this)" disabled>
                        <span id="sps6"></span>
                        <span style="margin-top: 10px;color: red;">（数量编辑通过批次列表修改）</span>
                    </div>
                </div>
                <div>
                    <label class="form-label col-xs-2"><span class="c-red">*</span>出库方名称:</label>

                    <div class="formControls col-xs-9 col-sm-4">
                        <input class="input-text disabled" disabled value="<{$data.order.out_object_name}>" name="out_object_name">
                        <span id="sps4"></span>
                    </div>
                </div>

            </div>
            <div  class="row cl col-sm-12">

                <div id="out_l" style="display: none;">

                    <label class="form-label col-xs-2" style="padding:0;"><span class="c-red">*</span>实际出库数量(升):</label>

                    <div class="formControls col-xs-9 col-sm-4">
                        <input class="input-text" value="" name="outbound_num_liter" id="outbound_num_liter" onkeyup="checknum2(this)" onblur="checkoutliter()" disabled>
                        <span id="sps8"></span>
                        <span style="margin-top: 10px;color: red;">（数量编辑通过批次列表修改）</span>
                    </div>

                </div>
                <div id="out_d" style="display: none;margin-left: 0px; padding-left: 0px;">

                    <label class="form-label col-xs-2" style="padding:0;">实际出库密度:</label>

                    <div class="formControls col-xs-9 col-sm-4">
                        <input class="input-text" value="<{$data['out_density']}>" name="out_density" id="out_density" onkeyup="checknum(this)" onblur="checkoutdensity(this)">
                    </div>

                </div>

            </div>

            <!--<div  class="row cl col-sm-12">
                <div id="out_d" style="display: none;margin-left: 0px; padding-left: 0px;">

                    <label class="form-label col-xs-2" style="padding:0;">实际出库密度:</label>

                    <div class="formControls col-xs-9 col-sm-4">
                        <input class="input-text" value="<{$data['out_density']}>" name="out_density" id="out_density" onkeyup="checknum(this)" onblur="checkoutdensity(this)">
                    </div>

                </div>
                <div  id="in_d" style="display: none;margin-right: 0px; padding-right: 0px;">

                    <div class="formControls col-xs-9 col-sm-4" style="float: right;">
                        <input class="input-text" value="<{$data['in_density']}>" name="in_density" id="in_density" onkeyup="checknum(this)" onblur="checkindensity(this)">
                    </div>

                    <label class="form-label col-xs-2" style="padding:0; float: right;">实际入库密度:</label>
                </div>
            </div>
            -->
        <div>
            <div class="row cl col-sm-12">
                <label class="form-label col-xs-2 ">出库单附件:</label>

                <div class="formControls col-xs-10 col-sm-10 wu-example">
                    <div class="yanzRight">
                        <span class="btn-upload form-group" style="width: 100%">
                            <input class="input-text upload-url radius" type="text" name="uploadfile-1" id="uploadfile-1" readonly style=" width: 70%;"> <a href="javascript:void();" class="btn btn-primary radius"><i class="iconfont">&#xf0020;</i> 浏览文件</a>
                            <input style="margin-top:5px;float: left;" name="attachment" id="attachment" onchange="previewImage(this,1)" type="file" multiple name="file-1" class="input-file"/>
                        </span>
                        <span class="dui" style="display: none;"></span>
                    </div>
                    <div id="preview1" style="clear:both; padding-top:15px;">
                        <img src="" alt="" id="imghead1" height="200" width="200" style="display:none;"/>
                    </div>
                </div>

            </div>
        </div>
        <div class="row cl col-sm-12">
            <input type="hidden" id="storehouse_id" value="<{$data.order.out_storehouse}>">
            <input type="hidden" id="goods_id" value="<{$data.order.goods_id}>">
            <input type="hidden" id="region" value="<{$data.order.out_region}>">
            <input type="hidden" id="stock_type" value="<{$data.order.out_stock_type}>">
            <input type="hidden" id="our_company_id" value="<{$data.order.our_company_id}>">
            <if condition="$data['order']['out_stock_type'] eq 4">
                <include file="./Application/Home/View/Common/batch_litre.html"/>
                <else />
                <include file="./Application/Home/View/Common/batch.html"/>
            </if>
        </div>
        <div>
            <div class="row cl col-sm-12">
                <label class="form-label col-xs-2 ">备注:</label>

                <div class="formControls col-xs-9 col-sm-9" style="padding-right: 0;">
                    <textarea class="textarea" cols="" rows="" id="outbound_remark" name="outbound_remark"></textarea>
                </div>
            </div>
        </div>
        </div>

        <div class="row cl col-sm-12" style="margin-top:10px;">
            <div class="col-xs-8 col-sm-6 col-xs-offset-4 col-sm-offset-6">
                <input type="hidden" id="id" name="id" value="<{$data.order.id}>"/>
                <input type="hidden" id="allocation_type" name="allocation_type" value="<{$data.order.allocation_type}>"/>
                <input type="hidden" id="business_type" name="business_type" value="<{$data.order.business_type}>"/>
                <input class="btn btn-primary radius" id="add" type="button" value="提交">
            </div>
        </div>
    </form>
</article>

<script type="text/javascript">
    //图片预览功能
    function previewImage(file,imgNum)
    {
        var MAXWIDTH  = 200;
        var MAXHEIGHT = 200;
        var div = document.getElementById('preview'+imgNum);
        if (file.files && file.files[0])
        {
            div.innerHTML ='';
            var length=0;
            //imgContent为图片展示的区域
            var reader=new FileReader();
            reader.readAsDataURL(file.files[length]);
            //异步读取图片，读取完会触onload
            reader.onload=function() {
                div.innerHTML += "<img src='" + this.result + "' id='imghead"+imgNum+'_'+length+"'/>";
                var img = document.getElementById('imghead'+imgNum+'_'+length);
                img.onload = function(){
                    var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
                    img.width  =  rect.width;
                    img.height =  rect.height;
                }
                //多张预览，上传多张时开启
//                length++;
//                if (length < file.files.length) {
//                    reader.readAsDataURL(file.files[length]);
//                }
            }
        }
        else //
        {
            var sFilter='filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale,src="';
            file.select();
            var src = document.selection.createRange().text;
            div.innerHTML = '<img id=imghead'+imgNum+'>';
            var img = document.getElementById('imghead2');
            img.filters.item('DXImageTransform.Microsoft.AlphaImageLoader').src = src;
            var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
            status =('rect:'+rect.top+','+rect.left+','+rect.width+','+rect.height);
            div.innerHTML = "<div id=divhead"+imgNum+" style='width:"+rect.width+"px;height:"+rect.height+"px;margin-top:"+rect.top+"px;"+sFilter+src+"\"'></div>";
        }
    }
    function clacImgZoomParam( maxWidth, maxHeight, width, height ){
        var param = {top:0, left:0, width:width, height:height};
        if( width>maxWidth || height>maxHeight )
        {
            rateWidth = width / maxWidth;
            rateHeight = height / maxHeight;

            if( rateWidth > rateHeight )
            {
                param.width =  maxWidth;
                param.height = Math.round(height / rateWidth);
            }else
            {
                param.width = Math.round(width / rateHeight);
                param.height = maxHeight;
            }
        }
        param.left = Math.round((maxWidth - param.width) / 2);
        param.top = Math.round((maxHeight - param.height) / 2);
        return param;
    }

    // @表单验证 <senpai | 2017.3.10>

    var allocation_type = $('#allocation_type').val();
    var out_t = $('#out_t');
    var out_l = $('#out_l');
    //var in_t = $('#in_t');
    //var in_l = $('#in_l');
    var out_d = $('#out_d');
    //var in_d = $('#in_d');
    if(allocation_type == 1 ){
        out_t.show();
        //in_t.show();
        //$("#actual_in_num").prop('disabled',true).addClass('disabled');
        out_l.hide();
        //in_l.show();
        out_d.hide();
        // 加油站采购业务 ， 商品密度不可修改
        getConfigDensityByAllocationType();
        //in_d.show();
    }else if(allocation_type == 2){
        out_t.show();
        //in_t.show();
        $("#outbound_num").prop('disabled',true).addClass('disabled');
        //$("#actual_in_num").prop('disabled',true).addClass('disabled');
        out_l.show();
        //in_l.show();
        out_d.show();
        //in_d.show();
    }else if(allocation_type == 3){
        out_t.show();
        //in_t.show();
        $("#outbound_num").prop('disabled',true).addClass('disabled');
        out_l.show();
        //in_l.hide();
        out_d.show();
        // 加油站采购业务 ， 商品密度不可修改
        getConfigDensityByAllocationType();
        //in_d.hide();
    }else if(allocation_type == 4){
        out_t.show();
        //in_t.show();
        out_l.hide();
        //in_l.hide();
        out_d.hide();
        //in_d.hide();
    }
    //验证信息正确
    function checktrue($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe676;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-green");
    }

    //验证信息错误
    function checkfalse($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe706;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-red");
    }

    //验证是否是数字（保留8位小数）
    function checknum8(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{8,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d{8}).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }
    //验证是否是数字（保留四位小数）
    function checknum(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{4,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d{4}).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }

    //验证是否是数字（保留三位小数）
    function checknum2(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d{2}).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }

    //根据升数计算吨数
    function checkoutliter() {
        if ($("#outbound_num_liter").val() && $("#out_density").val()) {
            $("#outbound_num").val(($("#out_density").val() * $("#outbound_num_liter").val() /1000).toFixed(8));
        }
    }

    //根据升数计算吨数
    function checkinliter() {
        if ($("#actual_in_num_liter").val() && $("#in_density").val()) {
            $("#actual_in_num").val(($("#in_density").val() * $("#actual_in_num_liter").val() / 1000).toFixed(8));
        }
    }

    //验证油品密度
    function checkoutdensity(density) {
        if ($.trim($(density).val()) < 0.7 || $.trim($(density).val()) > 1) {
            layer.msg("油品密度超出规格！", {icon: 2});
            checkfalse('sps6');
            submitFalse();
            return false;
        } else {
            checktrue('sps6');
            return true;
        }
    }

    //验证油品密度
    function checkindensity(density) {
        console.log($(density).val());
        if ($.trim($(density).val()) < 0.7 || $.trim($(density).val()) > 1) {
            layer.msg("油品密度超出规格！", {icon: 2});
            checkfalse('sps6');
            submitFalse();
            return false;
        } else {
            if ($("#actual_in_num_liter").val()) {
                $("#actual_in_num").val(($(density).val() * $("#actual_in_num_liter").val() / 1000).toFixed(4));
            }
            return true;
        }
    }

    // @确认调拨单
    $(function () {
        //添加erp商品操作
        $('#add').click(function () {
            submitTrue();
            if ($('#form-member-add').valid() == false) {
                return false;
            }

            //获取使用到的批次的升数
            var inputs = $('input[name="litre_num"]');//找到div里面所有的input
            console.log(inputs);
            var litre = new Object();
            inputs.each(function(){
                if (this.value != 0 && this.value != '' && this.value != null) {
                    litre[this.id] = this.value;
                }
            });
            //获取使用到的批次的密度
            var inputs = $('input[name="density"]');//找到div里面所有的input
            var density = new Object();
            inputs.each(function(){
                if (this.value != 0 && this.value != '' && this.value != null) {
                    density[this.id] = this.value;
                }
            });
            //获取使用到的批次的吨数
            var inputs = $('input[name="use_batch_num"]');//找到div里面所有的input
            var ton = new Object();
            inputs.each(function(){
                if (this.value != 0 && this.value != '' && this.value != null) {
                    ton[this.id] = this.value;
                }
            });
            var batch = {
                'litre' : litre,
                'density' : density,
                'ton' : ton,
            };

            var da = {
                'id': $("#id").val(),
                'actual_out_num': $.trim($("#outbound_num").val()),
                'actual_out_num_liter': $.trim($("#outbound_num_liter").val()),
                'allocation_type': $("#allocation_type").val(),
                'out_density': $("#out_density").val(),
                'outbound_remark': $("#outbound_remark").val(),
                'batch':JSON.stringify(batch),
            };

            var formData = new FormData();
            formData.append("attachment",$("#attachment")[0].files[0]);
            formData.append("id",da.id);
            formData.append("actual_out_num",da.actual_out_num);
            formData.append("actual_out_num_liter",da.actual_out_num_liter);
            formData.append("allocation_type",da.allocation_type);
            formData.append("out_density",da.out_density);
            formData.append("outbound_remark",da.outbound_remark);
            formData.append("batch",da.batch);

            if(da.allocation_type == 1){
                if(da.actual_out_num == '' || isNaN(da.actual_out_num)){
                    layer.msg('请输入实际出库数量', {icon: 2});
                    submitFalse();
                    return false;
                }

            }else if(da.allocation_type == 2){
                if(da.actual_out_num_liter == '' || isNaN(da.actual_out_num_liter)){
                    layer.msg('请输入实际出库升数', {icon: 2});
                    submitFalse();
                    return false;
                }

            }else if(da.allocation_type == 3){
                if(da.actual_out_num_liter == '' || isNaN(da.actual_out_num_liter)){
                    layer.msg('请输入实际出库升数', {icon: 2});
                    submitFalse();
                    return false;
                }

            }else if(da.allocation_type == 4){

                if(da.actual_out_num == '' || isNaN(da.actual_out_num)){
                    layer.msg('请输入实际出库数量', {icon: 2});
                    submitFalse();
                    return false;
                }

            }
            if(da.out_density == '' || da.out_density <= 0){
                layer.msg('请检查商品密度！', {icon: 2});
                submitFalse();
                return false;
            }

            layer.load(1, {shade: 0.3});

            $.ajax({
                url : '<{:U("ErpNewAllocation/confirmOutStock")}>',
                type: 'POST',
                data: formData,
                async: true,
                cache: false,
                contentType: false,
                processData: false,
                success : function(_data) {
                    if (_data.status == 1) {
                        layer.closeAll();
                        layer.msg(_data.message, {icon: 1});
                        top.searthesErpAllocationOrderList();
                        setTimeout(function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            submitFalse();
                        }, 1000);
                    } else {
                        layer.closeAll();
                        layer.msg(_data.message, {icon: 2});
                        submitFalse();
                    }
                },
                error:function(XMLHttpRequest, textStatus, errorThrown){
                    console.log(XMLHttpRequest);
                    console.log('请求异常，请检查！');
                }
            });
        });
    });

    // 城市仓 -> 二级仓
    function getConfigDensityByAllocationType(){
        if($("#business_type").val() == 1 ){
            getConfigDensity();
            $("#out_density").attr("disabled",true);
        }
    }
//
//    // 二级仓 -> 城市仓
//    function getConfigDensityByAllocationType(){
//        var config_density = getConfigDensity();
//        $("#out_density").val(config_density);
//        $("#out_density").attr("disabled",true);
//    }



    // 获取系统配置密度
    function getConfigDensity(){
        var url = '<{:U("ErpPurchase/getConfig")}>';
        var type = 'post';
        var dataType = 'json';
        var data = '';
        ajax(url, data, type, dataType, function (_data) {
            if (_data.status == 1) {
                $("#out_density").val(_data.config_density);
            } else {
                layer.closeAll();
                layer.msg(_data.message, {icon: 2});
                $("#out_density").val("");
                submitFalse();
                return false;
            }
        });
    }

    // @添加下单按钮禁用属性
    function submitTrue() {
        $('#add').attr("disabled", true);
    }

    // @移除下单按钮禁用属性
    function submitFalse() {
        $('#add').attr("disabled", false);
    }
</script>
