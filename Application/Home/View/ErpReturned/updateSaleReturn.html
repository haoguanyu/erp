<include file="./Application/Home/View/headers.html"/>
<style>
    .disabled {
        cursor: no-drop;
        background-color: #9D9D9D;
    }

    .input-text, select {
        width: 78%
    }
</style>
<div class="page-container">
    <form class="form form-horizontal" id="form-article-add">
        <div id="tab-system" class="HuiTab">
            <!--<div class="tabBar cl">-->
                <!--<span>基本信息</span>-->
                <!--&lt;!&ndash;<span>付款信息</span>&ndash;&gt;-->
            <!--</div>-->
            <div class="tabCon">
                <form action="" method="post" class="form form-horizontal" id="form-order-add">

                    <div style="overflow: hidden">
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">来源单号：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.source_order_number}>"
                                           id="source_number" name="source_number" maxlength="20" readonly />
                                </div>
                            </div>
                            

                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">交易员：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.dealer_name}>" placeholder=""
                                           id="dealer_name" name="dealer_name" disabled>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">业务类型：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="business_type" name="business_type" class="input-text" style="width:78%;">
                                        <option value="<{$data['order']['business_type']}>" selected="selected"><{$data['order']['business_type_info']}></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">用户：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="user_id" name="user_id" class="input-text" style="width:78%;">
                                        <option value="<{$data['order']['user_id']}>" selected="selected"><{$data['order']['user_name']}></option>
                                    </select>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">公司：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="company_id" name="company_id" class="input-text" style="width:78%;">
                                        <option value="<{$data['order']['company_id']}>" selected="selected"><{$data['order']['company_name']}></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">城市：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="region" name="region" class="input-text" style="width:78%;">
                                        <option value="0">请选择</option>
                                        <volist name="data.region_list" id="vo" key="k">
                                            <option value="<{$key}>" <if condition="$data['order']['region'] eq $key">selected</if>>
                                            <!--<option value="<{$key}>">-->
                                            <{$vo}>
                                            </option>
                                        </volist>
                                    </select>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">仓库：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="storehouse_id" name="storehouse_id" class="input-text" style="width:78%;">
                                        <option value="<{$data['order']['storehouse_id']}>" selected="selected"><{$data['order']['storehouse_name']}></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">油库：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="depot_id" name="depot_id" class="input-text" style="width:78%;">
                                        <option value="<{$data['order']['depot_id']}>" selected="selected"><{$data['order']['depot_name']}></option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">出库数量(吨)：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.outbound_quantity}>" placeholder="" id="outbound_quantity" name=" outbound_quantity">
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-2 col-sm-2">商品代号：</label>

                            <div class="formControls col-xs-10 col-sm-10" style="padding-left: 5px;">
                                <select name="search_goods_code" class="input-text" style="width:78%" id="search_goods_code">
                                    <option value="<{$data['order']['goods_id']}>" selected="selected"><{$data['order']['goods_name']}>/<{$data['order']['source_from']}>/<{$data['order']['grade']}>/<{$data['order']['level']}></option>
                                </select>
                            </div>
                        </div>
                    
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">销售数量：</label>
                                 <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.buy_num}>" id="buy_num" name="buy_num">
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">商品单价：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.price}>" id="price" name="price">
                                </div>
                            </div>
                        </div>

                         <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>退货日期：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text Wdate" value="<{$data.order.return_goods_time}>" onchange="checkReturnGoodsTime()"
                                           id="return_goods_time" name="return_goods_time"  maxlength="20" readonly onfocus="WdatePicker({lang:'zh-cn',dateFmt: 'yyyy-MM-dd'})"/>
                                    <span id="sps1"></span>
                                </div>
                            </div>

                        
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">退货区间(吨)：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.min_returned_num}>~<{$data.order.max_returned_num}>" placeholder="" id="no_returned_num" name="no_returned_num" onkeyup="checknum4(this)" maxlength="10">
                                    <input type="hidden" id="min_returned_num" value="<{$data.order.min_returned_num}>">
                                    <input type="hidden" id="max_returned_num" value="<{$data.order.max_returned_num}>">
                                </div>

                            </div>
                        </div>
            

                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>退货类型：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select name="return_type" class="input-text" style="width:78%" id="return_type" onchange="checkReturnType()">
                                        <option value="">请选择退货类型</option>
                                        <volist name="data.return_type" id="vo" key="k">
                                            <option value="<{$key}>" <if condition="$data['order']['return_type'] eq $key">selected</if>>
                                                <{$vo}>
                                            </option>
                                        </volist>
                                    </select>
                                    <span id="sps2"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>待提退货：</label>
                                <input type="checkbox" name= 'returnedMerchandise' <if condition="$data['order']['min_returned_num'] gt 0">checked</if>>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>退货数量(吨)：</label>
                                <input type="hidden" name="order_use_num" id="order_use_num" value="<{$data.order.return_goods_num}>">
                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.return_goods_num}>" placeholder="" id="actual_in_num" name="actual_in_num" onkeyup="checknum4(this)" maxlength="10" onchange="checkReturnGoodsNum()" readonly>
                                    <span id="sps3"></span>
                                </div>
                            </div>
                        </div>

                         <div class="row cl">
                            <label class="form-label col-xs-2 "></label>
                            <div class="row cl col-sm-10" >
                                <table class="table table-border table-bordered table-hover table-bg table-sort" id="dataTable">
                                    <thead>
                                    <tr class="text-c">
                                        <th>序号</th>
                                        <th>商品代码</th>
                                        <th>仓库</th>
                                        <th>系统批次号</th>
                                        <th>货权形式</th>
                                        <th>货权号</th>
                                        <th>出库数量</th>
                                        <th>退货数量</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        <volist name="userBatchList" id="batchInfo">
                                            <tr>
                                                <td><{$batchInfo['id']}></td>
                                                <td><{$batchInfo['goods_code']}></td>
                                                <td><{$batchInfo['storehouse_name']}></td>
                                                <td><{$batchInfo['sys_bn']}></td>
                                                <td><{$batchInfo['cargo_bn_type']}></td>
                                                <td><{$batchInfo['cargo_bn']}></td>
                                                <!--<td><{$batchInfo['actual_balance_num']}>--</td>-->
                                                <td><{$useStockOurNum[$batchInfo["id"]]}></td>
                                                <td><if condition="$useBatchNum[$batchInfo['id']]['status'] eq 10"><{$useBatchNum[$batchInfo['id']]['userNum']}>
                                                <else/>0</if></td>
                                            
                                            <tr/>
                                        </volist>
                                    </tbody>
                                </table>
                                <input type="hidden" id="order_subsidy_money" value="" name="order_subsidy_money">
                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-2 col-sm-2">备注：</label>

                            <div class="formControls col-xs-10 col-sm-10" style="padding-left: 5px;">
                                    <textarea id="remark" name="remark" style="height:100px;width:84%;"
                                              class="input-text"><{$data.order.remark}></textarea>
                            </div>
                        </div>

                        <div class="row cl">
                            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>退款走向备注：</label>

                            <div class="formControls col-xs-10 col-sm-10" style="padding-left: 5px;">
                                    <textarea id="refund_remark" name="refund_remark" style="height:100px;width:84%;"
                                              class="input-text" onblur="checkRefundRemark()"><{$data.order.refund_remark}></textarea>
                                <span id="sps4"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row cl" style="margin-top:20px;">
                        <div class="col-xs-8 col-sm-6 col-xs-offset-6 col-sm-offset-6">
                            <input type="hidden" name="id" id="id" value="<{$data.order.id}>">
                            <input type="hidden" name="id" id="source_order_id" value="<{$data.order.source_order_id}>">
                            <input class="btn btn-primary radius" id="DealerSaveBtn" type="button" value="提交">
                        </div>
                    </div>
                </form>
            </div>

        </div>
        <div class="row cl">
            <div class="col-xs-8 col-sm-8 col-xs-offset-4 col-sm-offset-2">
            </div>
        </div>
    </form>
</div>

<link rel="stylesheet" href="__TPL__lib/select2/css/select2.min.css"/>
<script type="text/javascript" src="__TPL__lib/select2/js/select2.full.js"></script>
<script type="text/javascript" src="__TPL__lib/select2/js/i18n/zh-CN.js"></script>

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript">
    $(function () {
        $('.skin-minimal input').iCheck({
            checkboxClass: 'icheckbox-blue',
            radioClass: 'iradio-blue',
            increaseArea: '20%'
        });
        $.Huitab("#tab-system .tabBar span", "#tab-system .tabCon", "current", "click", "0");

        $('form').find('input,textarea,select').attr('disabled', true).addClass('disabled');
        $('#return_goods_time,#remark,#refund_remark,#return_type,#actual_in_num,#DealerSaveBtn,#reset_num').attr('disabled', false).removeClass('disabled');
        var status = '<{$data.order.order_status}>';
        if (status != 1) {
            $('form').find('input,textarea,select').attr('disabled', true).addClass('disabled');
        }
        $('#DealerSaveBtn').attr('disabled', true).addClass('disabled');
    });
    /* 基本信息 */
    $('#DealerSaveBtn').click(function () {
        var da = {
            'id': $.trim($("#id").val()),
            'source_order_id': $.trim($("#source_order_id").val()),
            'source_order_number': $.trim($("#source_number").val()),
            'order_type': 1,
            'return_goods_time': $("#return_goods_time").val(),
            'return_goods_num': $.trim($("#actual_in_num").val()),
            'return_type': $("#return_type").val(),
            'remark': $.trim($("#remark").val()),
            'refund_remark': $.trim($("#refund_remark").val()),
        };

        if (checkReturnGoodsTime() && checkReturnType() && checkReturnGoodsNum() &&　checkRefundRemark()) {
            submitTrue();
            layer.load(1, {shade: 0.3});
            var url = '<{:U("ErpReturned/updateSaleReturn")}>';
            var type = 'post';
            var dataType = 'json';
            var data = da;

            ajax(url, data, type, dataType, function (_data) {
                if (_data.status == 1) {
                    layer.closeAll();
                    layer.msg(_data.message, {icon: 1});
                    parent.searchErpReturnedOrderList();
                    setTimeout(function () {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);

                    }, 500);
                } else {
                    layer.closeAll();
                    layer.msg(_data.message, {icon: 2});
                    submitFalse();
                    return false;
                }
            });
        }
    });

    // @添加下单按钮禁用属性
    function submitTrue() {
        $('#DealerSaveBtn').attr("disabled", true).addClass('disabled').val('处理中');
    }

    // @移除下单按钮禁用属性
    function submitFalse() {
        $('#DealerSaveBtn').attr("disabled", false).removeClass('disabled').val('提交');
    }
    /* @end 基本信息 */


    $('.table-sort tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        }
        else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    });


    //验证退货日期
    function checkReturnGoodsTime() {
        if ($.trim($("#return_goods_time").val()) == '') {
            layer.msg("请选择退货日期！", {icon: 2});
            checkfalse('sps1');
            return false;
        } else {
            checktrue('sps1');
            return true;
        }
    }

    //验证退货类型
    function checkReturnType() {
        if ($.trim($("#return_type").val()) == '') {
            layer.msg("请选择退货类型！", {icon: 2});
            checkfalse('sps2');
            return false;
        } else {
            checktrue('sps2');
            return true;
        }
    }

    //验证退货数量actual_in_num
    function checkReturnGoodsNum() {
        if ($.trim($("#actual_in_num").val()) == '') {
            layer.msg("请填写退货数量！", {icon: 2});
            checkfalse('sps3');
            return false;
        } else if (parseFloat($.trim($("#actual_in_num").val())) < parseFloat($.trim($("#min_returned_num").val())) || parseFloat($.trim($("#actual_in_num").val())) > parseFloat($.trim($("#max_returned_num").val()))) {
            layer.msg("退货数量不能超过可退货数量区间！", {icon: 2});
            checkfalse('sps3');
            return false;
        } else {
            checktrue('sps3');
            return true;
        }
    }

    //验证退款走向备注
    function checkRefundRemark() {
        if ($.trim($("#refund_remark").val()) == '') {
            layer.msg("请填写退款走向备注！", {icon: 2});
            checkfalse('sps4');
            return false;
        } else {
            checktrue('sps4');
            return true;
        }
    }

    //验证信息正确
    function checktrue($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe676;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-green");
    }

    //验证信息错误
    function checkfalse($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe706;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-red");
    }

    //验证是否是数字（保留两位小数）
    function checknum(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }

    //验证是否是数字（保留4位小数）
    function checknum4(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{4,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d{4}).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }

</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>