<include file="./Application/Home/View/headers.html"/>
<style>
    .disabled {
        cursor: no-drop;
        background-color: #9D9D9D;
    }
    .input-text{width: 78%;}
</style>
<div class="page-container">
    <form class="form form-horizontal" id="form-article-add">
        <div id="tab-spstem" class="HuiTab">
            <div class="tabBar cl">
                <span>基本信息</span>
                <!--<span>付款信息</span>-->
            </div>
            <div class="tabCon">
                <form action="" method="post" class="form form-horizontal" id="form-order-add">

                    <div style="overflow: hidden">
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>来源单号：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.order_number}>" id="order_number"
                                           disabled/>
                                    <span id="sps30"></span>
                                </div>
                            </div>

                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>订单金额(元)：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.order_amount}>"
                                           disabled/>
                                    <span id="sps31"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>下单日期：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text Wdate" value="<{$data.order.add_order_time}>"
                                           id="add_order_time" name="add_order_time" maxlength="20" disabled />
                                    <span id="sps1"></span>
                                </div>
                            </div>

                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>采购类型：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select class="input-text" disabled id="type" name="type" id="type" >
                                        <option value="1">自采</option>
                                    </select>
                                    <span id="sps2"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>我方公司：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="our_buy_company_id" name="our_buy_company_id" class="input-text" onchange="checkOurCompany();">
                                        <option value="0">请选择</option>
                                        <volist name="data.ourCompany" id="vo" key="k">
                                            <option value="<{$key}>"
                                            <if condition="$data['order']['our_buy_company_id'] eq $key">selected</if>>
                                            <{$vo}>
                                            </option>
                                        </volist>
                                    </select>
                                    <span id="sps3"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">业务类型：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="business_type" name="business_type" class="input-text" style="width:78%;">
                                        <option value="<{$data['order']['business_type']}>" selected="selected"><{$data['order']['business_type_info']}></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>采购员：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.buyer_dealer_name}>"
                                           placeholder="" id="buyer_dealer_name" name="buyer_dealer_name" disabled>
                                    <input type="hidden" id="buyer_dealer_id" name="buyer_dealer_id"
                                           value="<{$data.order.buyer_dealer_id}>">
                                    <span id="sps5"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>对方参考：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data.order.sale_number}>"
                                           placeholder="" id="sale_number" name="sale_number" maxlength="15" onblur="changeSaleNumber();">
                                    <span id="sps4"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>用户：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="sale_user_id" name="sale_user_id" class="input-text"
                                            onchange="changeUser()" style="width:78%;">
                                        <option value="<{$data['order']['sale_user_id']}>">
                                            <{$data['order']['s_user_name']}>-<{$data['order']['s_user_phone']}>
                                        </option>

                                    </select>
                                    <span id="sps6"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>供应商：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="sale_company_id" name="sale_company_id" class="input-text"
                                            onchange="changeCompany()">
                                        <option value="<{$data['order']['sale_company_id']}>"><{$data['order']['s_company_name']}></option>

                                    </select>
                                    <span id="sps7"></span>
                                    <input type="hidden" value="<{$data.order.sale_company_id}>"
                                           id="sale_company_default"/>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>所在城市：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="region" name="region" class="input-text" onchange="changeRegion()" style="width:78%;">
                                        <option value="0">请选择</option>
                                        <volist name="region.region_list" id="vo" key="k">
                                            <option value="<{$key}>"
                                            <if condition="$data['order']['region'] eq $key">selected</if>
                                            >
                                            <{$vo}>
                                            </option>
                                        </volist>
                                    </select>
                                    <span id="sps8"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>仓库：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="storehouse_id" name="storehouse_id" class="input-text" onchange="checkstorehouse()">
                                    </select>
                                    <span id="sps9"></span>
                                    <input type="hidden" value="<{$data.order.storehouse_id}>" id="storehouse_default"/>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>付款方式：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="pay_type" name="pay_type" class="input-text"
                                            onchange="changePayType(this.value)">
                                        <option value="0">请选择</option>
                                        <volist name="data.pay_type_list" id="vo" key="k">
                                            <option value="<{$key}>"
                                            <if condition="$data['order']['pay_type'] eq $key">selected</if>
                                            >
                                            <{$vo}>
                                            </option>
                                        </volist>
                                    </select>
                                    <span id="sps11"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>油库：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <select id="depot_id" name="depot_id" class="input-text" style="width:78%;" onchange="checkDepot();">
                                        <option value="0">请选择</option>

                                        <input type="hidden" value="<{$data.order.depot_id}>" id="depot_default"/>
                                    </select>
                                    <span id="sps10"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>账期天数：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" name="account_period" id="account_period"
                                           value="<{$data['order']['account_period']}>" maxlength="3" onblur="checkAccountPeriod();">
                                    <span id="sps13"></span>
                                </div>
                            </div>
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span id="span_prepay_ratio" class="c-red" style="display: none;">*</span>预付比例：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" name="prepay_ratio" id="prepay_ratio"
                                           value="<{$data['order']['prepay_ratio']}>" maxlength="4" style="width:78%" onblur="checkPrepayRatio();">
                                    <span>%</span>
                                    <span id="sps12"></span>
                                </div>

                            </div>
                        </div>
                        <div class="row cl">
                            <label class="form-label col-xs-2 col-sm-2">银行帐号：</label>

                            <div class="formControls col-xs-9 col-sm-9" style="padding-left: 6px">
                                <select id="sale_collection_info" name="sale_collection_info" class="input-text"
                                        style="width:95%;" onchange="checkCollectionInfo();">
                                    <option value="<{$data['order']['sale_collection_info']}>"><{$data['order']['sale_collection_info']}></option>
                                </select>
                                <span id="sps15"></span>
                                <input type="hidden" value="<{$data.order.sale_collection_info}>"
                                       id="sale_collection_info_default">
                            </div>
                        </div>
                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4">特需采购：</label>

                                <div class="formControls col-xs-8 col-sm-8 skin-minimal">
                                    <div class="check-box">
                                        <input type="checkbox" value="1" id="is_special" name="is_special"
                                        <{$data['order']['is_special'] == 1 ? 'checked' : ''}>>
                                        <label for="is_special">&nbsp;</label>
                                        <!--<span id="sps14"></span>-->
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <br/>
                        <p>商品信息</p>
                        <hr/>
                        <div class="row cl">
                            <div class="row cl col-sm-12">
                                <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>商品代码：</label>

                                <div class="formControls col-xs-10 col-sm-10" style="padding-left: 10px">
                                    <select type="text" class="input-text" value="" placeholder="" id="goods_code" name="goods_code" onchange="getGoodsInfo();" style="width: 70%;">
                                        <optgroup label="商品列表">
                                            <option value="">请选择</option>
                                            <volist name="data.erpGoods" id="vo" key="k">
                                                <IF condition="$vo.goods_code eq $data['order']['goods_code']">
                                                    <option value="<{$vo.goods_code}>" selected="selected">
                                                        <{$vo.goods_code}>/<{$vo.goods_name}>/<{$vo.source_from}>/<{$vo.grade}>/<{$vo.level}>
                                                    </option>
                                                    <else/>
                                                    <option value="<{$vo.goods_code}>">
                                                        <{$vo.goods_code}>/<{$vo.goods_name}>/<{$vo.source_from}>/<{$vo.grade}>/<{$vo.level}>
                                                    </option>
                                                </IF>
                                            </volist>
                                        </optgroup>
                                    </select>
                                    <input type="hidden" class="input-text" value="<{$data['order']['goods_id']}>"
                                           placeholder="" id="goods_id" name="goods_id">
                                    <span id="sps16"></span>
                                </div>
                            </div>

                        </div>

                        <div class="row cl">
                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>采购数量(吨)：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data['order']['goods_num']}>"
                                           placeholder="" id="goods_num" name="goods_num" maxlength="10" onblur="checkGoodsNum();">
                                    <span id="sps20"></span>
                                </div>
                            </div>

                            <div class="row cl col-sm-6">
                                <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>采购单价(元)：</label>

                                <div class="formControls col-xs-8 col-sm-8">
                                    <input type="text" class="input-text" value="<{$data['order']['price']}>"
                                           placeholder="" id="price" name="price"  maxlength="10" onblur="checkPrice();">
                                    <span id="sps22"></span>
                                </div>
                            </div>
                        </div>

                    <div class="row cl return_info">

                        <div class="row cl col-sm-6">
                            <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>退货日期：</label>

                            <div class="formControls col-xs-8 col-sm-8">
                                <input type="text" class="input-text Wdate" value="<{$data.returned.return_goods_time}>"
                                       id="return_goods_time" name="return_goods_time" maxlength="20" onfocus="WdatePicker({lang:'zh-cn',dateFmt: 'yyyy-MM-dd'})"/>
                            </div>
                        </div>

                        <div class="row cl col-sm-6">
                            <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>可退数量区间：</label>

                            <div class="formControls col-xs-8 col-sm-8">
                                <input type="text" class="input-text" value="<{$data.order.min_return_num}>~<{$data.order.can_return_goods_num}>"
                                       placeholder="" id="can_return_goods_num" name="can_return_goods_num" maxlength="10" >
                                <span id="sps25"></span>
                            </div>
                        </div>

                    </div>

                    <div class="row cl return_info">

                        <div class="row cl col-sm-6">
                            <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>退货类型：</label>

                            <div class="formControls col-xs-8 col-sm-8">
                                <select class="input-text" disabled id="return_type" name="return_type">
                                    <volist name="data.return_type" id="vo">
                                        <option value="<{$key}>" <if condition="$data['returned']['return_type'] eq $key"> selected </if>><{$vo}></option>
                                    </volist>

                                </select>
                                <span id="sps26"></span>
                            </div>
                        </div>

                        <div class="row cl col-sm-6">
                            <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>退货数量：</label>

                            <div class="formControls col-xs-8 col-sm-8">
                                <input type="text" class="input-text" value="<{$data.returned.return_goods_num}>"
                                       placeholder="" id="return_goods_num" name="return_goods_num" maxlength="10" onkeyup="checknum4(this)">
                                <span id="sps27"></span>
                            </div>
                        </div>

                    </div>
                    <div class="row cl return_info">
                        <div class="row cl col-sm-12">
                            <label class="form-label col-xs-2 col-sm-2">备注：</label>

                            <div class="formControls col-xs-10 col-sm-10">
                                <textarea id="remark" name="remark" style="height:100px;width:96%;"
                                          class="input-text"><{$data.returned.remark}></textarea>
                                <span id="sps23"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row cl return_info">
                        <div class="row cl col-sm-12">
                            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>退款走向备注：</label>

                            <div class="formControls col-xs-10 col-sm-10">
                            <textarea id="refund_remark" name="refund_remark" style="height:100px;width:96%;"
                                      class="input-text" placeholder="请告知退款走向，线下供应商挂账或实际退款，如不填写，财务会进行驳回处理"><{$data.returned.refund_remark}></textarea>
                                <span id="sps28"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row cl" style="margin-top:20px;">
                        <div class="col-xs-8 col-sm-6 col-xs-offset-6 col-sm-offset-6">
                            <input type="hidden" id="id" name="id" value="<{$data['returned']['id']}>">
                            <input class="btn btn-primary radius" id="DealerSaveBtn" type="button" value="提交">
                        </div>
                    </div>
                </div>
                </form>
            </div>

        </div>

    </form>
</div>

<link rel="stylesheet" href="__TPL__lib/select2/css/select2.min.css"/>
<script type="text/javascript" src="__TPL__lib/select2/js/select2.min.js"></script>

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript">
    $(function () {
        $('.skin-minimal input').iCheck({
            checkboxClass: 'icheckbox-blue',
            radioClass: 'iradio-blue',
            increaseArea: '20%'
        });
        $.Huitab("#tab-spstem .tabBar span", "#tab-spstem .tabCon", "current", "click", "0");

        var region = $("#region").val();
        //console.log(region);
//        iniDepot(region);
//        iniStorehouse(region);
        changeRegion();
        changeUser();

        var company_id = $('#sale_company_default').val();
        iniCollectionInfo(company_id);
        var pay_type = $('#pay_type').val();
        changePayType(pay_type);

        $('form').find('input,textarea,select').attr('disabled', true).addClass('disabled');
        checktrue('sps30');
        checktrue('sps31');
        checktrue('sps1');
        checktrue('sps2');
        checktrue('sps3');
        checktrue('sps4');
        checktrue('sps5');
        checkGoodsInfo();
        checkGoodsNum();
        checkPrice();
        //checkPrepayRatio();
        // $('.return_info').find('input,select,textarea').not('#can_return_goods_num').attr('disabled', false).removeClass('disabled');
        $('#DealerSaveBtn').attr('disabled', false).removeClass('disabled');
        var  is_edit = '<{$data.is_edit}>';
        if(is_edit == 0){
            // $('.return_info').find('input,select,textarea').attr('disabled', true).addClass('disabled');
            // $('#DealerSaveBtn').attr('disabled', true).addClass('disabled');
        }
    });
    //验证我方公司
    function checkOurCompany(){
        var v = $('#our_buy_company_id').val();
        if(v > 0){
            checktrue('sps3');
        }else{
            checkfalse('sps3');
        }
    }
    //验证对方参考
    function changeSaleNumber(){
        var v = $('#sale_number').val();
        if(v > 0){
            checktrue('sps4');
        }else{
            checkfalse('sps4');
        }
    }
    function checkUser(){
        var v = $('#sale_user_id').val();
        if(v > 0){
            checktrue('sps6');
        }else{
            checkfalse('sps6');
        }
    }

    function checkSaleCompany(){
        var v = $('#sale_company_id').val();
        if(v > 0){
            checktrue('sps7');
        }else{
            checkfalse('sps7');
        }
    }

    function checkRegion(){
        var v = $('#region').val();
        if(v > 0){
            checktrue('sps8');
        }else{
            checkfalse('sps8');
        }
    }

    function checkstorehouse(){
        var v = $('#storehouse_id').val();
        if(v > 0){
            checktrue('sps9');
        }else{
            checkfalse('sps9');
        }
    }

    function checkDepot(){

        var v = $('#depot_id').val();
        console.log(v);
        if(v > 0){
            checktrue('sps10');
        }else{
            checkfalse('sps10');
        }
    }

    function checkPayType(){
        var v = $('#our_buy_company_id').val();
        if(v > 0){
            checktrue('sps11');
        }else{
            checkfalse('sp11');
        }
    }

    function checkPrepayRatio(){
        var v = $('#prepay_ratio').val();
        if(v > 0 && v < 100){
            checktrue('sps12');
        }else{
            checkfalse('sps12');
        }
    }

    function checkAccountPeriod(){
        var v = $('#account_period').val();
        if(v > 0){
            checktrue('sps13');
        }else{
            checkfalse('sps13');
        }
    }
    function checkCollectionInfo(){
        var v = $('#sale_collection_info').val();
        if(v != ''){
            checktrue('sps15');
        }else{
            var sale_company_id = $('#sale_company_id').val();
            if(sale_company_id == 99999){
                checktrue('sps15');
            }else{
                checkfalse('sps15');
            }

        }
    }

    function checkGoodsInfo(){
        var goods_id = $('#goods_id').val();
        if(goods_id > 0){
            checktrue('sps16');
        }else{
            checkfalse('sps16');
        }

    }
    function checkGoodsNum(){
        var v = $('#goods_num').val();
        if(v != ''){
            checktrue('sps20');
        }else{
            checkfalse('sps20');
        }
    }
    function checkPrice(){
        var v = $('#price').val();
        if(v != ''){
            checktrue('sps22');
        }else{
            checkfalse('sps22');
        }
    }
    //console.log(depots);
    /* 基本信息 */
    $('#DealerSaveBtn').click(function () {

        submitTrue();
        var da = {
            'id': $.trim($("#id").val()),
//            'source_order_id': $.trim($("#id").val()),
            //'source_order_number': $.trim($("#order_number").val()),
            'return_type': $.trim($("#return_type").val()),
            'return_goods_num': $.trim($("#return_goods_num").val()),
            'return_goods_time': $.trim($("#return_goods_time").val()),
            'return_price': $.trim($("#price").val()),
            'remark': $.trim($("#remark").val()),
            'refund_remark': $.trim($("#refund_remark").val()),
        };

        if (da.return_goods_time == '') {
            layer.msg('请选择退货时间', {icon: 2});
            checkOurCompany();
            submitFalse();
            return false;
        }
        else if (da.return_goods_num == '') {
            layer.msg('请输入退货数量', {icon: 2});
            //checksalenum();
            submitFalse();
            return false;
        }else if (da.return_goods_num <= 0) {
            layer.msg('退货数量必须大于0', {icon: 2});
            submitFalse();
            return false;
        }else if (da.refund_remark == '') {
            layer.msg('退款走向备注', {icon: 2});
            submitFalse();
            return false;
        }
        else {
            layer.load(1, {shade: 0.3});
            var url = '<{:U("ErpReturned/editPurchaseReturn")}>';
            var type = 'post';
            var dataType = 'json';
            var data = da;

            ajax(url, data, type, dataType, function (_data) {
                if (_data.status == 1) {
                    layer.closeAll();
                    layer.msg(_data.message, {icon: 1});
                    //top.searchErpPurchaseReturnList();
                    parent.searchPurchaseReturnOrderList();
                    setTimeout(function () {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                        submitFalse();
                    }, 500);
                } else {
                    layer.closeAll();
                    layer.msg(_data.message, {icon: 2});
                    submitFalse();
                    return false;
                }
            });
        }
    });


    // @添加下单按钮禁用属性
    function submitTrue() {
        $('#DealerSaveBtn').attr("disabled", true).addClass('disabled').val('处理中');
    }

    // @移除下单按钮禁用属性
    function submitFalse() {
        $('#DealerSaveBtn').attr("disabled", false).removeClass('disabled').val('提交');
    }
    /* @end 基本信息 */

    /* 拜访记录 */

    function saveVisitInfo() {
        var url = '<{:U("User/saveVisitInfo")}>';
        var data = $('#form-visit-add').serialize();
        data.id = '<{$Think.get.id}>';
        var dataType = 'json';
        var type = 'post';
        ajax(url, data, type, dataType, function (_data) {
            if (_data.status == 1) {
                layer.msg(_data.message, {icon: 1});
                window.location.reload();
                return false;
            } else {
                layer.msg(_data.message, {icon: 2});
                return false;
            }
        })
    }

    $('.table-sort tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
        }
        else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
    });


    var selectUsers = $("#sale_user_id").select2({
        placeholder: '请选择用户',

    }).on('select2-open', function () {
        $(this).data('select2').results.addClass('overflow-hidden').perfectScrollbar();
    });

    //    var selectCompany = $("#sale_company_id").select2({
    //        placeholder: '请选择供应商',
    //        //allowClear: true
    //    }).on('select2-open', function()
    //    {
    //        $(this).data('select2').results.addClass('overflow-hidden').perfectScrollbar();
    //    });
    var selectUsers = $("#region").select2({
        placeholder: '请选择城市',

    }).on('select2-open', function () {
        $(this).data('select2').results.addClass('overflow-hidden').perfectScrollbar();
    });

    //选择油库（可复用）
    var selectDepot2 = $("#depot_id").select2({
        //allowClear: true
        placeholder: '请选择油库',
    }).on('select2-open', function () {
        $(this).data('select2').results.addClass('overflow-hidden').perfectScrollbar();
    });

    function changeUser() {
        var user_id = $('#sale_user_id').val();
        if (user_id) {
            $('#sale_collection_info').html('<option value="">请选择</option>'); //重置银行帐号信息
            //var url = '<{:U("User/getInfoById")}>';
            var url = '<{:U("ErpSupplier/getSupplierInfoByUserId")}>';
            var data = {id: user_id,type:2};
            var dataType = 'json';
            var type = 'post';
            ajax(url, data, type, dataType, function (_data) {
                if (_data['c_name'].length > 0) {
                    var sale_company_default = $('#sale_company_default').val();
                    var option = '<option value="">请选择</option>';
                    var select = sale_company_default == 99999 ? 'selected' : '';

                    option += '<option value="99999" ' + select + '>不限</option>';
                    var selected = '';
                    for (var i in _data['c_name']) {
                        selected = _data['c_name'][i].id == sale_company_default ? 'selected' : '';
                        option += '<option value="' + _data['c_name'][i].id + '" ' + selected + '>' + _data['c_name'][i].company_name + '</option>';
                    }

                    checktrue('sps7');
                } else {
                    var option = '<option value="">暂无公司</option>';
                    checkfalse('sps7');

                }

                $('#sale_company_id').html(option);
            });
        }
        checkUser();

    }
    function changeCompany() {
        var company_id = $('#sale_company_id').val() || $('#sale_collection_info_default').val();
        //var sale_collection_info_default = $('#sale_collection_info_default').val();
        iniCollectionInfo(company_id);
        checkSaleCompany();
    }
    //初始化银行帐号信息
    function iniCollectionInfo(company_id) {
        var sale_collection_info_default = $('#sale_collection_info_default').val();
        //var url = '<{:U("Clients/getRemittance")}>';
        var url = '<{:U("ErpSupplier/getSupplierBankInfo")}>';
        var type = 'post';
        var dataType = 'json';
        var data = {company: company_id, all: 1};
        $('#sale_collection_info').html('');
        ajax(url, data, type, dataType, function (_data) {
            if (!$.isEmptyObject(_data)) {
                //var options = '<option value="">请选择</option>';
                var selected = '';
                for (var i in _data) {
                    var content = _data[i].backname + '--'+_data[i].backnum;
                    selected = sale_collection_info_default == content ? 'selected' : '';
                    options += '<option value="' + content + '" ' + selected + '>' + content + '</option>';

                }

            } else {
                var options = '<option value="">-暂无银行帐号-</option>';
            }
            $('#sale_collection_info').html(options);
            checkCollectionInfo();
        })
    }
    function changeRegion() {
        var region = $('#region').val();
        //console.log(region);
        iniDepot(region);
        iniStorehouse(region);
        checkRegion();

    }
    var depots = <{$data['depots']}>;

    //console.log(depots);
    var storehouses = <{$data.storehouse}>;

    function iniDepot(region) {

        var depot_default = $("#depot_default").val();
        var options = '';
        options += '<option value="0">请选择油库</option>';
        if (depot_default == 99999) {
            options += '<option value="99999" selected="selected">不限油库</option>';
            checktrue('sps10');
        } else {
            options += '<option value="99999">不限油库</option>';
        }
        if (!$.isEmptyObject(depots[region])) {
            for (var i in depots[region]) {
                if (depot_default == depots[region][i].id) {
                    options += '<option value="' + depots[region][i].id + '" selected="selected">' + depots[region][i].depot_name + '</option>';
                } else {
                    options += '<option value="' + depots[region][i].id + '">' + depots[region][i].depot_name + '</option>';
                }
            }
            checktrue('sps10');
        }
        $('#depot_id').html(options);
    }

    function iniStorehouse(region) {
        //var storehouse_id = $("#storehouse_id").val();
        checkstorehouse();
        var storehouse_id = $("#storehouse_default").val();
        var options = '';
        options += '<option value="0">请选择仓库</option>';

        if (!$.isEmptyObject(storehouses[region])) {
            for (var i in storehouses[region]) {
                if (storehouse_id == storehouses[region][i].id) {
                    options += '<option value="' + storehouses[region][i].id + '" selected="selected">' + storehouses[region][i].storehouse_name + '</option>';
                } else {
                    options += '<option value="' + storehouses[region][i].id + '">' + storehouses[region][i].storehouse_name + '</option>';
                }
            }
            checktrue('sps9');
        }else{
            checkfalse('sps9');
        }
        $('#storehouse_id').html(options);
    }

    /**
     *切换付款类型
     */
    function changePayType(v) {
        //console.log(v);
        var v = $('#pay_type').val();
        if (v == 1) {
            $('#span_prepay_ratio').hide();
            $('#prepay_ratio').prop('disabled', true).val('');
            $('#account_period').prop('disabled', true).val('');
        } else if (v == 2) {
            $('#span_prepay_ratio').show();
            $('#prepay_ratio').prop('disabled', false);
            $('#account_period').prop('disabled', true).val('');
        } else if (v == 3) {
            $('#span_prepay_ratio').hide();
            $('#prepay_ratio').prop('disabled', true).val('');
            $('#account_period').prop('disabled', false);
        }
        checkPayType();
    }
    /**
     * 通过商品代码获取商品信息
     */
    function getGoodsInfo() {
        var goods_code = $.trim($('#goods_code').val());
        var url = '<{:U("ErpGoods/getGoodsByCode")}>';
        var type = 'post';
        var dataType = 'json';
        var data = {goods_code: goods_code};

        ajax(url, data, type, dataType, function (_data) {
            if (!$.isEmptyObject(_data)) {
                $('#goods_id').val(_data.id);
                $('#goods_name').val(_data.goods_name);
                $('#goods_from').val(_data.source_from);
                $('#goods_grade').val(_data.grade);
                $('#goods_level').val(_data.level);

            } else {
                $('#goods_id').val(0);
                $('#goods_name').val('无');
                $('#goods_from').val('无');
                $('#goods_grade').val('无');
                $('#goods_level').val('无');
            }
            checkGoodsInfo();
            //$('#sale_collection_info').html(options);
        })
    }

    //验证信息正确
    function checktrue($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe676;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-green");
    }

    //验证信息错误
    function checkfalse($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe706;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-red");
    }

    var selectGoodsCode = $("#goods_code").select2({
        placeholder: '请选择商品',
        language: "zh-CN",

    }).on('select2-open', function () {
        $(this).data('select2').results.addClass('overflow-hidden').perfectScrollbar();
    });

    //验证是否是数字（保留4位小数）
    function checknum4(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{4,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d{4}).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }

    //验证是否是数字（保留两位小数）
    function checknum(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }
</script>
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>