<include file="./Application/Home/View/headers.html"/>
<link rel="stylesheet" href="__TPL__lib/select2/css/select2.min.css"/>
<style>
    .disabled {
        cursor: no-drop;
        background-color: #9D9D9D;
    }
    .input-text {
        width: 78%
    }
</style>
<script type="text/javascript" src="__TPL__lib/select2/js/select2.min.js"></script>
<script type="text/javascript" src="__TPL__static/select.js"></script>
<article class="page-container" style=" overflow:hidden;" id="input_list">
    <form action="" method="post" class="form form-horizontal" id="form-member-add">
        <div style="overflow: hidden">
            <div class="row cl">
                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">业务单号：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="order_number" id="order_number" value="<{$data.order_number}>">
                    </div>
                </div>

                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">申请人：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="creator" id="creator" value="<{$data.creator}>">
                    </div>
                </div>
            </div>

            <div class="row cl">
                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">供应商(公司)：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="company_name" id="company_name" value="<{$data.company_name}>">
                    </div>
                </div>

                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">订单总额：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="order_amount" id="order_amount" value="<{$data.order_amount}>">
                    </div>
                </div>
            </div>

            <div class="row cl">
                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">申请金额：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="pay_money" id="pay_money" value="<{$data.pay_money}>">
                    </div>
                </div>

                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">预付款余额：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="account_balance" id="account_balance" value="<{$data.account_balance}>">
                    </div>
                </div>
            </div>

            <div class="row cl">
                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">实际付款金额：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text disabled" disabled name="actual_pay_money" id="actual_pay_money" value="<{$data.pay_money}>">
                    </div>
                </div>
                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4">抵扣余额：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <input type="text" class="input-text" name="balance_deduction" id="balance_deduction" value="0" onkeyup="checknum(this);checkbalancededuction()">
                        <span id="sps1"></span>
                    </div>
                </div>
            </div>
            <div class="row cl" id="hide" style="display: none">
                <div class="row cl col-sm-6">
                    <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>是否转预付：</label>

                    <div class="formControls col-xs-8 col-sm-8">
                        <label>
                            <input type="radio"  name="is_prepay_money" value="1" placeholder=""/>&nbsp; 是 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        </label>
                        <label>
                            <input type="radio"  name="is_prepay_money" value="2" checked placeholder=""/> &nbsp; 否
                        </label>
                    </div>
                </div>
            </div>
            <div id="bank_hide">
                <div class="row cl">
                    <div class="row cl col-sm-6">
                        <label class="form-label col-xs-4 col-sm-4"><span class="c-red">*</span>银行简称：</label>

                        <div class="formControls col-xs-8 col-sm-8">
                            <select name="bank_simple_name" class="input-text" style="width:78%" id="bank_simple_name" onchange="update_bank_info()">
                            <optgroup label="银行简称">
                                <option value="0">请选择简称</option>
                                <volist name="data.bank" id="vo" key="k">
                                    <option value="<{$key}>" bank_name="<{$vo.bank_simple_name}>" <if condition="$vo['is_first'] eq 1">selected</if>>
                                        <{$vo.bank_simple_name}>
                                    </option>
                                </volist>
                            </optgroup>
                        </select>
                            <span id="sps2"></span>
                        </div>

                    </div>

                    <div class="row cl col-sm-6">
                        <label class="form-label col-xs-4 col-sm-4"></label>

                        <div class="formControls col-xs-8 col-sm-8">
                        </div>
                    </div>
                </div>
                <div class="row cl">
                    <div class="row cl col-sm-6">
                        <label class="form-label col-xs-4 col-sm-4">银行名称：</label>

                        <div class="formControls col-xs-8 col-sm-8">
                            <input type="text" class="input-text disabled " disabled name="bank_name" id="bank_name" >
                        </div>
                    </div>

                    <div class="row cl col-sm-6">
                        <label class="form-label col-xs-4 col-sm-4">银行账号：</label>

                        <div class="formControls col-xs-8 col-sm-8">
                            <input type="text" class="input-text disabled" disabled name="bank_num" id="bank_num" >
                        </div>
                    </div>
                </div>
            </div>
            <div class="row cl">
                <div class="row cl col-sm-12">
                    <label class="form-label col-xs-2 col-sm-2">申请备注：</label>

                    <div class="formControls col-xs-10 col-sm-10" style="padding-left: 10px;">
                        <textarea id="remark" name="remark" disabled style="height:100px;width:88%;" class="input-text disabled"><{$data.remark}></textarea>
                    </div>
                </div>
            </div>
            <div class="row cl">
                <div class="row cl col-sm-12">
                    <div class="col-xs-4 col-sm-4 col-xs-offset-4 col-sm-offset-4">
                        <input type="hidden" id="id" name="id" value="<{$id}>"/>
                        <input type="hidden" id="order_type" name="order_type" value="<{$data.order_type}>"/>
                        <input class="btn btn-primary radius" id="add" type="button" value="&nbsp;&nbsp;确认&nbsp;&nbsp;">
                        <input class="btn btn-primary radius" id="close_no" style="height:auto;margin-left: 80px;" type="button" value="&nbsp;&nbsp;退出&nbsp;&nbsp;">
                    </div>
                </div>
            </div>
        </div>
    </form>
</article>

<script type="text/javascript">

    var bank_info = <{$data.bank_json}>;
    // @添加
    $(function () {

        // ----------------------------银行信息账号改版----------------------//
        // 采退单 需要显示 是否转预存
        if($.trim($("#order_type").val()) == 2){
            $("#hide").css('display','block');
            $("#balance_deduction").val(0) ;
            $("#balance_deduction").attr("disabled",true)
        }
        // 预付款余额
        if(parseFloat($("#account_balance").val()) <= 0 ) {
            $("#balance_deduction").val(0) ;
            $("#balance_deduction").attr("disabled",true)
        }

        // 判断账套公司银行账号是否配置
        if($("select[name=bank_simple_name] option").size() <= 1 ){
            if($.trim($("#order_type").val()) == 2){
                layer.msg("该账套下银行账号信息未配置，只能转预付！", {icon: 2});
            }else{
                layer.msg("该账套下银行账号信息未配置，只能使用余额抵扣！", {icon: 2});
            }
        };

        // 判断是否存在首选 ，如果是首选，则需要补充银行账号和银行名称
        var bank_id = $.trim($("#bank_simple_name").val());
        if(bank_id > 0 ){
            $("#bank_name").val(bank_info[bank_id]['bank_name']);
            $("#bank_num").val(bank_info[bank_id]['bank_num']);
        }else{
            $("#bank_name").val('');
            $("#bank_num").val('');
        }

        // 如果为采退，并且是转预存情况，则无需展示银行信息。
        // 这里不需要把选项置空，Event 有判断
        $("input[name='is_prepay_money']").click(function () {
            if($.trim($("input[name='is_prepay_money']:checked").val()) ==  1 ){
                $("#bank_hide").css('display','none');
            }else{
                $("#bank_hide").css('display','block');
            }

        });
        // ------------------------end -------------------------------------//

        //添加
        $('#add').click(function () {
            if ($('#form-member-add').valid() == false) {
                return false;
            }
            if (checkbalancededuction() && check_bank() && check_bank_return()) {
                layer.load(1, {shade: 0.3});
                var da = {
                    'id': $("#id").val(),
                    'balance_deduction': $.trim($("#balance_deduction").val()),
                    'bank_id'   :$.trim($("#bank_simple_name").val()),
                    'bank_simple_name' : $.trim($("#bank_simple_name option:selected").text()),
                    'is_prepay_money'  : $.trim($("input[name='is_prepay_money']:checked").val()),
                };
                if(parseFloat(da.balance_deduction) <= 0){
                    // 没有使用余额抵扣
                    da.prepay_status = 0 ;
                }else{
                    // 使用了余额抵扣
                    da.prepay_status = 1 ;
                }
                var url = '<{:U("ErpFinance/paymentConfirmation")}>';
                var type = 'post';
                var dataType = 'json';
                var data = da;
                submitTrue();
                ajax(url, data, type, dataType, function (_data) {
                    layer.load(1, {shade: 0.3});
                    if (_data.status == 1) {
                        if (_data.new_code) {
                            setTimeout(function () {
                                layer.closeAll();
                                top.searthes_erpPurchasePaymentList();
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                                submitFalse();
                            }, 1000);
                        } else {
                            layer.msg(_data.message, {icon: 1});
                            setTimeout(function () {
                                layer.closeAll();
                                top.searthes_erpPurchasePaymentList();
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                                submitFalse();
                            }, 1000);
                        }
                    } else {
                        layer.closeAll();
                        layer.msg(_data.message, {icon: 2});
                        submitFalse();
                    }
                });
            }
        });
    });

    //验证余额抵扣
    function checkbalancededuction() {

        // 余额抵扣
        var balance_deduction = $.trim($("#balance_deduction").val());
        if(balance_deduction == '') balance_deduction = 0 ;

        // 实际应付金额
        var actual_pay_money  = parseFloat($("#pay_money").val()) - parseFloat(balance_deduction);
        $("#actual_pay_money").val(parseFloat(actual_pay_money.toFixed(2)));

        // 申请金额
        $pay_money =  parseFloat($.trim($("#pay_money").val()));
        if ((parseFloat(actual_pay_money.toFixed(2)) != $pay_money) && (parseFloat(balance_deduction) == '' || parseFloat(balance_deduction) <= 0)) {
            layer.msg("请输入余额抵扣！", {icon: 2});
            checkfalse('sps1');
            submitFalse();
            return false;
        } else if (parseFloat(balance_deduction) > parseFloat($("#account_balance").val())) {
            layer.msg("抵扣余额不能大于账户余额！", {icon: 2});
            checkfalse('sps1');
            submitFalse();
            return false;
        } else if (parseFloat(balance_deduction) > $pay_money) {
            layer.msg("抵扣余额不能大于申请付款金额！", {icon: 2});
            checkfalse('sps1');
            submitFalse();
            return false;
        } else {
            // 如果抵扣金额 = 申请付款金额，则需要隐藏银行简称选项
            if(parseFloat(balance_deduction) == $pay_money){
                // $("#bank_simple_name").attr("disabled",true);
                $("#bank_simple_name").select2("val", 0);
                $("#bank_hide").css('display','none');
            }else if($.trim($("input[name='is_prepay_money']:checked").val()) == 1) {
                $("#bank_simple_name").select2("val", 0);
                $("#bank_hide").css('display','none');
            }else{
                $("#bank_hide").css('display','block');
            }
            //checktrue('sps1');
            return true;
        }
    }

    // 验证是否发生了金钱往来，但是未选择银行账套（采购单）
    function check_bank(){
        // 如果余额抵扣 != 申请金额 则发生了银行交易
        if(parseFloat($.trim($("#balance_deduction").val())) != parseFloat($.trim($("#pay_money").val())) && $.trim($("#order_type").val()) == 1  && $.trim($("#bank_simple_name").val()) <= 0){
            layer.msg("发生银行往来，请确认银行信息！", {icon: 2});
            checkfalse('sps2');
            return false;
        }
        checktrue('sps2');
        return true;
    }

    // 验证是否发生了金钱往来，但是未选择银行账套（采退单）
    function check_bank_return(){
        // 如果余额抵扣 != 申请金额 则发生了银行交易
        if($.trim($("input[name='is_prepay_money']:checked").val()) == 2 && $.trim($("#order_type").val()) == 2  && $.trim($("#bank_simple_name").val()) <= 0){
            layer.msg("发生银行往来，请确认银行信息！", {icon: 2});
            checkfalse('sps2');
            return false;
        }
        checktrue('sps2');
        return true;
    }

    //验证是否是数字（保留两位小数）
    function checknum(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
        if(obj.value.indexOf(".") == 0){
            obj.value = '';
        }
    }

    //验证信息正确
    function checktrue($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe676;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-green");
    }

    //验证信息错误
    function checkfalse($place) {
        $('#' + $place).html("<i class='Hui-iconfont'>&#xe706;</i>");
        $('#' + $place).removeClass();
        $('#' + $place).addClass("c-red");
    }

    var selectRegion = $("#bank_simple_name").select2({
        placeholder: '请选择城市',
        //allowClear: true
    }).on('select2-open', function () {
        $(this).data('select2').results.addClass('overflow-hidden').perfectScrollbar();
    });

    // 选择简称，更换银行账号和信息
    function update_bank_info(){
        var bank_id = $.trim($("#bank_simple_name").val());
        if(bank_id > 0 ){
            // 获取最新的银行账号、名称
            var url = '<{:U("ErpBank/getErpBankInfoById")}>';
            var type = 'post';
            var dataType = 'json';
            var data = { 'id':bank_id};
            ajax(url, data, type, dataType, function (_data) {
                layer.load(1, {shade: 0.3});
                if (_data.status == 1) {
                    layer.closeAll();
                    $("#bank_name").val(_data.bank_name);
                    $("#bank_num").val(_data.bank_num);
                } else {
                    layer.closeAll();
                    checkfalse('sps2');
                    $("#bank_name").val('');
                    $("#bank_num").val('');
                    layer.msg('该笔银行账号信息有误，请刷新后重试！', {icon: 2});
                }
            });
            //$("#bank_name").val(bank_info[bank_id]['bank_name']);
            //$("#bank_num").val(bank_info[bank_id]['bank_num']);
        }else{
            $("#bank_name").val('');
            $("#bank_num").val('');
        }
    }

    // 关闭窗口
    $('#close_no').click(function(){
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    });

    // @添加下单按钮禁用属性
    function submitTrue() {
        $('#add').attr("disabled", true);
    }

    // @移除下单按钮禁用属性
    function submitFalse() {
        $('#add').attr("disabled", false);
    }
</script>
